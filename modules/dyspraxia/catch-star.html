<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch the Star - Dyspraxia Module | Cogno Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/dark-mode.css">
    <link rel="stylesheet" href="../../css/mobile-nav.css">
    <link rel="stylesheet" href="../../css/modules-responsive.css">
    
    <style>
        /* Mobile Navigation Styles */
        @media (max-width: 768px) {
            body { padding-bottom: calc(64px + env(safe-area-inset-bottom, 0px) + 16px); }
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; width: 100% !important; padding: 1rem !important; }
            .hide-xs { display: none !important; }
            #gameCanvas { height: 350px !important; }
            video { height: 300px !important; }
        }
        /* bottom-nav visible on all screens */
    </style>

    <style>
        body { font-family: 'Lexend', sans-serif; background: var(--color-background); color: var(--color-text-primary); transition: background-color 0.3s; }
        .game-container { position: relative; width: 100%; max-width: 800px; margin: 0 auto; }
        #gameCanvas { 
            width: 100%; 
            height: 500px; 
            background: #0c0c1d; 
            border-radius: var(--radius-xl); 
            border: 2px solid #ffd700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        .instruction { text-align: center; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: var(--radius-lg); margin-bottom: 20px; border: 1px solid rgba(255, 215, 0, 0.2); }
        video { 
            width: 100%; 
            height: 400px; 
            background: black; 
            border-radius: var(--radius-xl); 
            border: 3px solid var(--color-border);
            transform: scaleX(-1);
            transition: all 0.3s;
        }
        
        body.dark-mode video { border-color: #333; }
    </style>
</head>
<body>
    <div class="activity-container">
        <!-- New Activity Navbar (Mobile) -->
        <header class="activity-navbar">
            <button class="back-btn" onclick="window.history.back()">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div class="activity-title-group">
                <span class="activity-category">Dyspraxia</span>
                <h1 class="activity-name">Catch the Star</h1>
            </div>
            <div class="activity-actions">
                <button class="action-btn" id="dark-mode-toggle"><i class="fa-solid fa-moon"></i></button>
            </div>
        </header>

        <main class="main-content">
            <div class="activity-header hide-xs mb-8">
                <div class="flex items-center gap-4 mb-2">
                    <button onclick="window.history.back()" class="text-primary hover:text-primary-dark transition text-2xl">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <h1 class="text-3xl font-bold">‚≠ê Catch the Star</h1>
                </div>
                <p class="text-gray-500">Form a basket with your hands to catch falling stars!</p>
            </div>

            <div class="max-w-4xl mx-auto bg-surface rounded-3xl p-6 md:p-8 shadow-xl border border-border">
                <div class="instruction mb-6">
                    üåü <strong>How to Play</strong> - Cup your hands together to form a basket shape. Catch falling stars before they disappear!
                </div>

                <!-- Webcam Feed -->
                <div class="webcam-feed mb-6 relative">
                    <video id="videoElement" autoplay playsinline></video>
                    <div id="connectionStatus" class="absolute bottom-4 left-0 right-0 text-center text-sm font-semibold px-4">
                        <span class="bg-black/60 text-yellow-400 px-3 py-1 rounded-full">‚è≥ Connecting to camera...</span>
                    </div>
                </div>

                <!-- Game Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-yellow-500/10 rounded-2xl p-4 text-center border border-yellow-500/20">
                        <div class="text-2xl font-bold text-yellow-500" id="starScore">0</div>
                        <div class="text-xs text-secondary uppercase">Stars Caught</div>
                    </div>
                    <div class="bg-purple-500/10 rounded-2xl p-4 text-center border border-purple-500/20">
                        <div class="text-2xl font-bold text-purple-500" id="combo">0x</div>
                        <div class="text-xs text-secondary uppercase">Combo</div>
                    </div>
                    <div class="bg-blue-500/10 rounded-2xl p-4 text-center border border-blue-500/20">
                        <div class="text-2xl font-bold text-blue-500" id="missed">0</div>
                        <div class="text-xs text-secondary uppercase">Missed</div>
                    </div>
                    <div class="bg-green-500/10 rounded-2xl p-4 text-center border border-green-500/20">
                        <div class="text-2xl font-bold text-green-500" id="gameTimer">45</div>
                        <div class="text-xs text-secondary uppercase">Seconds Left</div>
                    </div>
                </div>

                <!-- Game Canvas -->
                <div class="game-container mb-6">
                    <canvas id="gameCanvas"></canvas>
                </div>

                <!-- Controls -->
                <div class="flex gap-4 justify-center">
                    <button id="startBtn" class="btn btn-primary btn-lg px-10">
                        <i class="fa-solid fa-play mr-2"></i> Start Game
                    </button>
                    <button id="resetBtn" class="btn btn-ghost btn-lg px-10 hidden">
                        <i class="fa-solid fa-rotate mr-2"></i> Reset
                    </button>
                </div>

                <!-- Instructions -->
                <div class="mt-8 bg-surface-variant rounded-2xl p-6 border-l-4 border-yellow-500">
                    <h3 class="font-bold text-yellow-500 mb-3 uppercase text-sm tracking-wider">üìã Guidelines:</h3>
                    <ul class="text-sm space-y-2 opacity-80 list-disc list-inside">
                        <li>Allow camera access when prompted</li>
                        <li>Cup your hands together to form a basket üß∫</li>
                        <li>Move the basket to catch falling stars</li>
                        <li>Build combos by catching stars consecutively!</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-client.js"></script>
    <script src="../../js/activity-tracker.js"></script>
    <script src="../../js/notifications.js"></script>
    <script src="../../js/utils.js"></script>
    <script src="../../modules/modules.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            CognoModules.initDarkMode();
        });

        const BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : '';
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('videoElement');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const scoreDisplay = document.getElementById('starScore');
        const comboDisplay = document.getElementById('combo');
        const missedDisplay = document.getElementById('missed');
        const timerDisplay = document.getElementById('gameTimer');
        const connectionStatus = document.getElementById('connectionStatus');

        let gameActive = false;
        let stars = [];
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let missed = 0;
        let timeRemaining = 45;
        let gameStartTime = 0;
        let handLandmarks = [];
        let backendConnected = false;
        let frameAnalysisEnabled = true;
        let lastFrameAnalysis = 0;
        let isAnalyzing = false;
        const FRAME_THROTTLE_MS = 80;

        const HAND_CONNECTIONS = [
            [0, 1], [1, 2], [2, 3], [3, 4],
            [0, 5], [5, 6], [6, 7], [7, 8],
            [0, 9], [9, 10], [10, 11], [11, 12],
            [0, 13], [13, 14], [14, 15], [15, 16],
            [0, 17], [17, 18], [18, 19], [19, 20],
            [5, 9], [9, 13], [13, 17]
        ];

        const BASKET_POINTS = [4, 8, 12, 16, 20]; 
        const PALM_POINTS = [0, 5, 9, 13, 17]; 

        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        let backgroundStars = [];
        for (let i = 0; i < 100; i++) {
            backgroundStars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2,
                twinkle: Math.random() * Math.PI * 2
            });
        }

        function drawBackground() {
            ctx.fillStyle = '#0c0c1d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const time = Date.now() / 1000;
            backgroundStars.forEach(star => {
                const opacity = 0.3 + 0.7 * Math.sin(time * 2 + star.twinkle);
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawHandBasket() {
            if (!handLandmarks || handLandmarks.length === 0) return;

            handLandmarks.forEach((hand) => {
                const fingertips = BASKET_POINTS.map(idx => ({
                    x: hand[idx].x * canvas.width,
                    y: hand[idx].y * canvas.height
                }));
                const palmPoints = PALM_POINTS.map(idx => ({
                    x: hand[idx].x * canvas.width,
                    y: hand[idx].y * canvas.height
                }));

                const centerX = fingertips.reduce((sum, p) => sum + p.x, 0) / fingertips.length;
                const centerY = fingertips.reduce((sum, p) => sum + p.y, 0) / fingertips.length;
                const palmCenterY = palmPoints.reduce((sum, p) => sum + p.y, 0) / palmPoints.length;

                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.shadowColor = '#FFD700';
                ctx.shadowBlur = 15;

                ctx.beginPath();
                ctx.moveTo(fingertips[0].x, fingertips[0].y);
                for (let i = 1; i < fingertips.length; i++) {
                    ctx.lineTo(fingertips[i].x, fingertips[i].y);
                }
                ctx.stroke();

                ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                ctx.lineWidth = 2;
                for (let i = 0; i < 3; i++) {
                    const t = (i + 1) / 4;
                    ctx.beginPath();
                    fingertips.forEach((tip, idx) => {
                        const palm = palmPoints[Math.min(idx, palmPoints.length - 1)];
                        const x = tip.x + (palm.x - tip.x) * t;
                        const y = tip.y + (palm.y - tip.y) * t;
                        if (idx === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                }

                fingertips.forEach((tip) => {
                    const gradient = ctx.createRadialGradient(tip.x, tip.y, 0, tip.x, tip.y, 12);
                    gradient.addColorStop(0, '#FFFFFF');
                    gradient.addColorStop(0.3, '#FFD700');
                    gradient.addColorStop(1, 'rgba(255, 215, 0, 0)');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(tip.x, tip.y, 12, 0, Math.PI * 2);
                    ctx.fill();
                });
            });
            ctx.shadowBlur = 0;
        }

        function getBasketBounds() {
            if (!handLandmarks || handLandmarks.length === 0) return null;
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            handLandmarks.forEach(hand => {
                [...BASKET_POINTS, ...PALM_POINTS].forEach(idx => {
                    const x = hand[idx].x * canvas.width;
                    const y = hand[idx].y * canvas.height;
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                });
            });
            return { minX, maxX, minY, maxY };
        }

        function createStar() {
            const size = 20 + Math.random() * 15;
            stars.push({
                x: 50 + Math.random() * (canvas.width - 100),
                y: -30,
                size: size,
                velocity: 2 + Math.random() * 2,
                rotation: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.1,
                color: Math.random() > 0.8 ? '#FF69B4' : '#FFD700',
                points: Math.random() > 0.9 ? 6 : 5,
                isSpecial: Math.random() > 0.9
            });
        }

        function drawStar(x, y, radius, points, rotation, color, isSpecial) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(rotation);
            ctx.shadowColor = color;
            ctx.shadowBlur = isSpecial ? 25 : 15;
            ctx.fillStyle = color;
            ctx.beginPath();
            for (let i = 0; i < points * 2; i++) {
                const r = i % 2 === 0 ? radius : radius / 2;
                const angle = (i * Math.PI) / points - Math.PI / 2;
                if (i === 0) ctx.moveTo(r * Math.cos(angle), r * Math.sin(angle));
                else ctx.lineTo(r * Math.cos(angle), r * Math.sin(angle));
            }
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                video.srcObject = stream;
                connectionStatus.innerHTML = '<span class="bg-black/60 text-green-400 px-3 py-1 rounded-full">‚úÖ Camera Ready</span>';
            } catch (err) {
                connectionStatus.innerHTML = '<span class="bg-black/60 text-red-400 px-3 py-1 rounded-full">‚ùå Camera Denied</span>';
            }
        }

        async function analyzeFrame() {
            if (!video.srcObject || video.videoWidth === 0 || isAnalyzing) return;
            const now = Date.now();
            if (now - lastFrameAnalysis < FRAME_THROTTLE_MS) return;
            lastFrameAnalysis = now;
            isAnalyzing = true;

            try {
                const canvas_temp = document.createElement('canvas');
                canvas_temp.width = video.videoWidth;
                canvas_temp.height = video.videoHeight;
                const ctx_temp = canvas_temp.getContext('2d');
                ctx_temp.scale(-1, 1);
                ctx_temp.drawImage(video, -canvas_temp.width, 0);
                const base64Data = canvas_temp.toDataURL('image/jpeg', 0.6).split(',')[1];
                
                const response = await fetch(`${BACKEND_URL}/api/dyspraxia/analyze-frame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame_data: base64Data, exercise_type: 'hands' })
                });

                if (response.ok) {
                    const data = await response.json();
                    handLandmarks = data.hand_landmarks || [];
                }
            } catch (err) {
                console.error('Frame analysis error:', err);
            } finally {
                isAnalyzing = false;
            }
        }

        function gameLoop() {
            drawBackground();
            analyzeFrame();
            drawHandBasket();

            if (gameActive) {
                stars.forEach((star, index) => {
                    drawStar(star.x, star.y, star.size, star.points, star.rotation, star.color, star.isSpecial);
                    star.y += star.velocity;
                    star.rotation += star.rotationSpeed;

                    const basket = getBasketBounds();
                    if (basket && star.x > basket.minX - 20 && star.x < basket.maxX + 20 &&
                        star.y > basket.minY - 10 && star.y < basket.maxY + 10) {
                        score += (star.isSpecial ? 5 : 1) * (1 + Math.floor(combo / 5));
                        combo++;
                        maxCombo = Math.max(maxCombo, combo);
                        stars.splice(index, 1);
                        scoreDisplay.textContent = score;
                        comboDisplay.textContent = combo + 'x';
                        CognoNotifications?.toast?.success(star.isSpecial ? 'SUPER STAR!' : 'Caught!');
                        return;
                    }

                    if (star.y > canvas.height + 50) {
                        missed++;
                        combo = 0;
                        comboDisplay.textContent = '0x';
                        missedDisplay.textContent = missed;
                        stars.splice(index, 1);
                    }
                });

                if (Math.random() < 0.035) createStar();
            } else {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
                ctx.font = 'bold 24px Lexend';
                ctx.textAlign = 'center';
                ctx.fillText('‚≠ê Press Start to Begin! ‚≠ê', canvas.width / 2, canvas.height / 2);
                ctx.textAlign = 'left';
            }

            requestAnimationFrame(gameLoop);
        }

        startBtn.addEventListener('click', () => {
            gameActive = true;
            score = 0;
            combo = 0;
            missed = 0;
            timeRemaining = 45;
            stars = [];
            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '0x';
            missedDisplay.textContent = '0';
            startBtn.classList.add('hidden');
            resetBtn.classList.remove('hidden');

            const timer = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = timeRemaining;
                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    endGame();
                }
            }, 1000);
        });

        async function endGame() {
            gameActive = false;
            startBtn.classList.remove('hidden');
            resetBtn.classList.add('hidden');
            
            const accuracy = score + missed > 0 ? Math.round((score / (score + missed)) * 100) : 100;
            CognoNotifications?.toast?.info(`Game Over! Stars: ${score}, Accuracy: ${accuracy}%`);
            
            try {
                await CognoTracker?.saveActivity({
                    moduleId: 'dyspraxia',
                    activityId: 'catch-star',
                    score: score,
                    maxScore: score + missed,
                    duration: 45,
                    metadata: { starsCaught: score, maxCombo, accuracy }
                });
            } catch (e) { console.error(e); }
        }

        resetBtn.addEventListener('click', () => location.reload());

        initCamera();
        gameLoop();
    </script>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="bottom-nav">
        <a href="../../dashboard/child-dashboard.html" class="nav-item">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="../../learn/index.html" class="nav-item active">
            <i class="fa-solid fa-book-open"></i>
            <span>Learn</span>
        </a>
        <a href="../../doctors/index.html" class="nav-item">
            <i class="fa-solid fa-user-doctor"></i>
            <span>Doctors</span>
        </a>
        <a href="../../learning-hub/index.html" class="nav-item">
            <i class="fa-solid fa-graduation-cap"></i>
            <span>Hub</span>
        </a>
        <a href="../../progress/index.html" class="nav-item">
            <i class="fa-solid fa-chart-line"></i>
            <span>Progress</span>
        </a>
        <a href="../../profile/index.html" class="nav-item">
            <i class="fa-solid fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>
</body>
</html>
